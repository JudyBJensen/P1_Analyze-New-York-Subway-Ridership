---
output: 
  html_document: 
    fig_height: 3.5
    toc: yes
---
#Prosper Data Exploration
Judy Jensen, P4 Final project

##Data exploration and analysis
###Univariate Plots
```{r, echo=FALSE}

# Import and review
file <- '~/Udacity - Data Analyst/P4 Explore and Summarize Data/P4 Project Folder/prosperLoanData.csv'
prosper <- read.csv(file)
```

####subset of prosper loan data
```{r, echo = FALSE, warning = FALSE, results = 'hide'}
#Review all data (suppress for final report)
str(prosper)
summary(prosper)
```

```{r, echo = FALSE, warning=FALSE}
#Wrangle data
#create ordered factor for income range:
prosper$IncomeRange <- ordered(prosper$IncomeRange, 
                               levels = c("$0","$1-24,999","$25,000-49,999",
                                          "$50,000-74,999", "$75,000-99,999",
                                          "$100,000+", "Not employed", 
                                          'Not displayed'))

#create ordered factor for loan status
prosper$LoanStatus <- ordered(prosper$LoanStatus, 
                              levels = c("Current","FinalPaymentInProgress",
                                         "Completed", "Past Due (1-15 days)", 
                                         "Past Due (16-30 days)", 
                                         "Past Due (31-60 days)", 
                                         "Past Due (61-90 days)", 
                                         "Past Due (91-120 days)", 
                                         "Past Due (>120 days)",  "Defaulted",
                                         "Chargedoff","Cancelled"))

#create new variable with loan = good, default, late
#Source:  http://stackoverflow.com/questions/20984701/how-to-create-a-new-
#column-with-multiple-values-based-on-another-column-in-r
map_column <- rep(c("good standing", "good standing", "good standing", "late",
                    "late","late", "late", "late", "late", "default", 
                    "default", NA), 2)

prosper$LStatus <- map_column[prosper$LoanStatus] 

prosper$LStatus <- ordered(prosper$LStatus, levels = c("good standing",
                                                       "late","default"))


#create variable, year, from loanOriginationDate
prosper$LoanOriginationDate <- as.Date(prosper$LoanOriginationDate)
prosper$year <- as.numeric(format(prosper$LoanOriginationDate, format = "%Y"))

#take a look at data (post)
dim(prosper)
str(prosper[c(6,8,16,20,21,22,27:43,47,48,50,64,65,82,83)])
summary(prosper[c(6,8,16,20,21,22,27:43,47,48,50,64,65,82,83)])
```
#####Data - Initial Observations
* 114k observations of 81 variables!  Looked for natural groupings of the variable to provide some focus for the exploration.  
  + borrower details - income, debt to income ratio, FICO score, home ownership, credit status (revolving credit, etc, customer #, employment status, etc)  
  + Prosper calculation of borrowers credit-worthiness  
  + Loan parameters (amount paid to date, amount borrowed, duration, monthly payment, payment status)  
  + Loan price (APR, fees)  
  + Marketing / referrals  


I will primarily focus on the borrower details, loan parameters, and prosper's calculation of creditworthiness as they relate to the price of the loan, and also on the payment status of the loan (good, late, default).  

#####Data Wrangling
Created two new variables - Year (year loan initiated) and LStatus (consolidated LoanStatus into 3 levels - good, late, default).  In addition, I created ordered factors for IncomeRange and LoanStatus so these plots would be logical.  

#####Overview

1. Over 80% of Prosper Loans are complete or current (LStaus = good standing: (95k / 114k). 

2. Borrower Details
  + median Income (monthly * 12) = 56k v. US household median = 52k
  + http://www.census.gov/content/dam/Census/library/publications/2014/acs/acsbr13-02.pdf  
  + ProsperScore - range is 1 to 11 (50% between 4 and 8) 
  + CreditScoreRangeUpper - range is 19 to 899 (50% between 679 and 739).  
  + Distribution credit scores for Prosper are tighter than the US average FICO score distribution  
  Q  |FICO    | CreditScoreUpper  
  -- |------- | ------------------  
  Q1 |600-649 | 679  
  Q2 |700-749 | 704  
  Q3 |750-799 | 739  
*Source:  FICO - http://www.fico.com/en/blogs/risk-compliance/us-credit-quality-continues-climb-will-level/*  

3. Loan details (range from 1st Qu to 3rd Qu)
  + APR between 15.6 and 28.3%
  + Loan size between 4000 and 12000
  + Term is 36 mos on majority of loans

```{r, echo = FALSE, warning=FALSE, message=FALSE}
#load up packages
library(ggplot2)
library(gridExtra)
library(dplyr)
```

```{r, echo = FALSE, warning=FALSE, message= FALSE, fig.height= 5}
#distributions of loans - income
plot1_inc <- ggplot(data = subset(prosper, 
                                  prosper$IncomeRange != "Not displayed"), 
                    aes(x = IncomeRange))+
  geom_histogram()+
  theme(axis.text.x = element_text(angle = 45))+
  theme(text = element_text(size = 10))+
  ggtitle("IncomeRange Distribution")

plot2_inc <- ggplot(data = prosper, aes(x = StatedMonthlyIncome*12))+
  geom_histogram(binwidth = 5000)+
  xlab("Annual Income")+
  theme(text = element_text(size = 10))+
  ggtitle("Annual Income Distribution")+
  scale_x_continuous(limits = c(0,150000), breaks = seq(0,150000, 25000))

plot3_inc <- ggplot(data = prosper, aes(x = EmploymentStatusDuration/12))+
  geom_histogram(binwidth = 0.5)+
  theme(text = element_text(size = 10))+
  ggtitle("Years Employed Distribution")+
  xlim(c(0, quantile(prosper$EmploymentStatusDuration/12, probs = 0.99, 
                     na.rm = TRUE)))

grid.arrange(plot1_inc, plot2_inc, plot3_inc, ncol = 2)
```

These distributions are for variables related to income.  

* Most borrowers have income between $25k and $75k.  
* Plotting the monthly income X 12 (Annual Income) reveals more detail about the distribution which is a normal distribution  
* The length of employment status is not normal, and is unexpected from the point of view that the first quartile of borrowers have been employed for just over 2 years (26 mos).  This may be due to changes in employment status, but also possibly the attractiveness to newer workers of a new loan type. 

```{r, echo = FALSE, warning=FALSE, message = FALSE, fig.height = 6.5}
#credit worthiness distributions
plot1_crd <- ggplot(data = prosper, aes(x = DebtToIncomeRatio))+
  geom_histogram(binwidth = 0.02)+
  theme(text = element_text(size = 10))+
  xlim(c(0, quantile(prosper$DebtToIncomeRatio, probs = 0.99, na.rm = TRUE)))+
  ggtitle("DebtToIncome Distribution")

plot2_crd <- ggplot(data = prosper, aes(x = TotalCreditLinespast7years))+
  geom_histogram(binwidth = 1)+
  theme(text = element_text(size = 10))+
  xlim(c(0, quantile(prosper$TotalCreditLinespast7years, probs = 0.99, 
                     na.rm = TRUE)))+
  ggtitle("Total Credit Lines, 7years Distribution")

plot3_crd <- ggplot(data = prosper, aes(x = OpenRevolvingMonthlyPayment))+
  geom_histogram()+
  theme(text = element_text(size = 10))+
  xlim(c(0, quantile(prosper$OpenRevolvingMonthlyPayment, probs = 0.99, 
                     na.rm = TRUE)))+
  ggtitle("Open Revolving Monthly Payment Distribution")

plot4_crd <-ggplot(data = prosper, aes(x = BankcardUtilization))+
  geom_histogram(binwidth = .01)+
  theme(text = element_text(size = 10))+
  xlim(c(0,2))+
  ggtitle("Credit Card Utilization Distribution")

plot5_crd <- ggplot(data = prosper, aes(x = CurrentCreditLines))+
  geom_histogram(binwidth = 1)+
  theme(text = element_text(size = 10))+
  xlim(c(0, quantile(prosper$CurrentCreditLines, probs = 0.99, na.rm = TRUE)))+
  ggtitle("Current Credit Lines Distribution")

grid.arrange(plot1_crd, plot2_crd, plot3_crd, plot4_crd, plot5_crd, ncol = 2)
```

These distributions are related to credit-worthiness for Prosper borrowers and were selected to reflect the variety of variables in the dataset.  These variables will be tuned in the bivariate analysis.  
  + Debt to income ratio is a median of 0.22  
  + Credit Line, 7 years has a median of 25  
  + Current credit lines is 10.  
the above plots all appear to be normal distributions.  
  + Revolving Monthly Payment distributions is not normal more skewed to lower payments     
  + Bankcard utilization is not normal, and high with a median of 60%. 
  
```{r, echo = FALSE, warning=FALSE}
ggplot(data = prosper, aes(x = OpenRevolvingMonthlyPayment))+
  geom_histogram(binwidth = 5)+
  theme(text = element_text(size = 10))+
  xlim(c(1,500))+
  ggtitle("Open Revolving Monthly Payment <= $500 Distribution")
```

(closer look at Revolving Monthly Payments does not reveal additional interesting information)  

```{r, echo = FALSE, warning=FALSE}
plot1_loan <- ggplot(data = prosper, aes(x = LoanOriginalAmount))+
  geom_histogram(binwidth = 500)+
  theme(text = element_text(size = 10))+
  ggtitle("Original Loan Amount Distribution")

plot2_loan <- ggplot(data = prosper, aes(x = BorrowerAPR))+
  geom_histogram(binwidth = 0.005)+
  theme(text = element_text(size = 10))+
  ggtitle("Borrower APR Distribution")

grid.arrange(plot1_loan, plot2_loan, ncol = 2)

ggplot(data = prosper, aes(x = BorrowerAPR))+
  geom_histogram(binwidth = 0.005)+
  theme(text = element_text(size = 10))+
  scale_y_log10(breaks = c(1,100,1000,10000))+
  facet_wrap(~year)
```

Loan amounts have distinct bands at increments of $5k with 5k, 10k and 15k being the most popular loan amounts.  
APR also appear to group at slightly below 10%, 20%, and 30% with a peak at 0.36 which is primarily from 2011 and 2012.  

```{r, echo = FALSE, warning=FALSE, message = FALSE}
#distribution of credit rating
plot4 <- ggplot(data = prosper, aes(x = CreditScoreRangeUpper))+
  geom_histogram(binwidth = 20)+
  theme(text = element_text(size = 10))+
  scale_x_continuous(limits = c(500,900), breaks = seq(500, 900, 50))+
  ggtitle("Credit Score Range Distribution")

plot5 <- ggplot(data = prosper, aes(x = ProsperScore))+
  geom_histogram(binwidth = 1)+
  theme(text = element_text(size = 10))+
  scale_x_continuous(limits = c(1,11), breaks = seq(1,11,1))+
  ggtitle("ProsperScore Distribution")

grid.arrange(plot4, plot5, ncol = 1)
```

The range of FICO scores (CreditScoreRangeUpper) has a small peak at ~ 550, and then a peak near the median of 699.  The distribution on the ProsperScore is unusual with several spikes along the peak of the distribution.  

```{r, echo = FALSE, warning=FALSE, message = FALSE}
ggplot(data = prosper, aes(x = year))+
  geom_histogram()+
  scale_x_continuous(limits = c(2005,2014), breaks = seq(2005,2014,1))+
  ggtitle("Loan Distribution by year")
```

After an SEC initiated in hiatus in 2009, the number of loans is growing at a strong rate.  *Source:  https://en.wikipedia.org/wiki/Prosper_Marketplace*

####Summary of Univariate Analysis  
1. Borrower Income Details  
  + Median annual income is 56k  
  + Median employment duration is 5y 7 mos  
2. Borrower Credit Details  
  + Debt to income ratio is a median of 0.22  
  + Credit Line, 7 years has a median of 25  
  + Current credit lines median is 10.  
  + Revolving Monthly Payment median is $271     
  + Bankcard utilization is high with a median of 60%. 
3. Loan Details  
  + Median APR is 21.0%  
  + Median loan size is 6500, middle range is 4k-12k  
Bivariate analysis will be utilized to determine which of these factors correlates most strongly with loan details and loan status.  At this point, there is no obvious additional data shaping required beyond the items already discussed - creating LStatus from LoanStatus and updating certain factors to ordered factors.  
  

###Bivariate Plots

```{r, echo = FALSE, warning=FALSE, results = 'hide'}
#http://www.statmethods.net/management/subset.html
#create a subset with credit-worthiness variables, 8,16,27:43,47,50,64,82)]
names(prosper)
set.seed(0510)
prosper.sample <- prosper[sample(1:length(prosper$BorrowerAPR), 10000), ]

sub.prosper <- prosper.sample[c(8,16,27,29:34)]
sub1.prosper <- prosper.sample[c(8,16,35:41)]
sub2.prosper <- prosper.sample[c(8,16,42,43,47,50,64,82)]
#final variables based on preceding pairs;  
sub3.prosper <- prosper.sample[c(8,16,27,43,64,38,34, 82)]
names(sub3.prosper)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.height= 7}
library(GGally)
library(scales)
library(memisc)

#ggpairs(sub.prosper, params = c(shape = I('.'), outlier.shape = I('.')))
#ggpairs(sub1.prosper, params = c(shape = I('.'), outlier.shape = I('.')))
#ggpairs(sub2.prosper, params = c(shape = I('.'), outlier.shape = I('.')))

#final based on precedinng pairs
ggpairs(sub3.prosper, params = c(shape = I('.'), outlier.shape = I('.')), 
        axisLabels = 'none', columnLabels = 
          (c("APR", "ProspScor", "CrdScor", "CardAvail" ,"LoanAmt", "Del,7yr",
             "Inq,6Mos","Status")))+
  theme(text = element_text(size = 8))
```

The following variables have the highest correlation to the APR(price) of the loan -  
positive correlation (increase APR):  Delinquencies Last 7 Years, Inquiries last 6 Months   
negative correlation (decrease APR): Prosper Score, Credit Score Range Upper, Available Bankcard Credit, Loan Original Amount  


#### Review key variables against BorrowerAPR
```{r, echo = FALSE, warning=FALSE, message=FALSE}

ggplot(data = prosper, aes(x = StatedMonthlyIncome*12, y = BorrowerAPR))+
  geom_point(alpha = 0.02)+
  xlim(c(quantile(prosper$StatedMonthlyIncome*12, probs = 0.01, na.rm = TRUE), 
         quantile(prosper$StatedMonthlyIncome*12, probs = 0.99, na.rm = TRUE)))+
  geom_smooth(color = 'red')+
  xlab("Annual Income")+
  ggtitle("Annual Income v APR")

ggplot(data = prosper, aes(x = EmploymentStatusDuration/12, y = BorrowerAPR))+
  geom_point(alpha = 0.02)+
  geom_smooth()+
  ggtitle("Years Employed v. APR")+
  xlab("Years Employed")+
  xlim(c(0, quantile(prosper$EmploymentStatusDuration/12, probs = 0.99, 
                     na.rm = TRUE)))

#nothing interesting in first 2 years of employment...  
#ggplot(data = prosper, aes(x = EmploymentStatusDuration/12, y = BorrowerAPR))+
#  geom_point(alpha = 0.02)+
#  geom_smooth()+
#  ggtitle("Years Employed v. APR")+
#  xlab("Years Employed")+
#  xlim(c(0, 2))

```

Annual Income does have an effect on APR, borrower APR declines ~ 5% between 25k and 125k and then is no longer affected by income.  
There does not appear to be any correlation between APR and the length of employment.  

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=6.5}

#credit measurements based on ggpairs results:  Prosper and CreditScoreRange

plot1x_rating <- ggplot(data=subset(prosper, !is.na(ProsperScore)), 
                        aes(x = factor(ProsperScore), y = BorrowerAPR))+
  geom_boxplot()+
  geom_smooth(aes(group = 1), color = 'red')+
  theme(text = element_text(size = 10))+
  ggtitle("Prosper Score v. APR")

plot2x_rating <- ggplot(data=subset(prosper, !is.na(CreditScoreRangeUpper)), 
                        aes(x=factor(CreditScoreRangeUpper), y=BorrowerAPR))+
  geom_boxplot()+
  geom_smooth(aes(group = 1), color = 'red')+
  theme(text = element_text(size = 10))+
  ggtitle("Credit Score v. APR")

plot3x_rating <- ggplot(data = prosper, 
                        aes(x = CreditScoreRangeUpper, y = ProsperScore))+
  geom_jitter(alpha = 0.01)+
  xlim(c(quantile(prosper$CreditScoreRangeUpper, probs = 0.01, 
                  na.rm=TRUE),900))+
  geom_smooth()+
  theme(text = element_text(size = 10))+
  ggtitle("Credit Score v. Prosper Score")

grid.arrange(plot3x_rating, plot1x_rating, plot2x_rating)

```

This set of charts that shows a linear relationship between ProsperScore and CreditScoreUpper above 6 / 700 respectively but not at lower credit ratings.  
The plots of Prosper score and Credit Score indicate why this is the case - APR remains flat with CreditScoreUpper until about 579, and doesn't decrease noticeably until 680-700.  The ProsperScore plot is more linear. 

```{r, echo = FALSE, warning=FALSE, message=FALSE}
cor.test(prosper$ProsperScore, prosper$CreditScoreRangeUpper)

```


```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.width= 7, fig.height=8}
plot1_crd <- ggplot(data = subset(prosper, prosper$AvailableBankcardCredit >0 & 
                                    !is.na(prosper$AvailableBankcardCredit)), 
                    aes(x = log10(AvailableBankcardCredit), y = BorrowerAPR))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  theme(text = element_text(size = 10))

plot2_crd <- ggplot(data = prosper, 
                    aes(x = LoanOriginalAmount, y = BorrowerAPR))+
  geom_point(alpha = 0.02)+
  geom_smooth(color = "red")+
  scale_x_continuous(limits = c(0,35000), breaks = seq(0,35000,5000))+
  theme(text = element_text(size = 10))

plot3_crd <- ggplot(data = prosper, 
                    aes(x = DelinquenciesLast7Years, y = BorrowerAPR))+
  geom_point(alpha = 0.02)+
  geom_smooth()+
  xlim(c(0, quantile(prosper$DelinquenciesLast7Years, probs = 0.99, 
                     na.rm = TRUE)))+
  theme(text = element_text(size = 10))
quantile(prosper$InquiriesLast6Months, probs = 0.99, na.rm = TRUE)
plot4_crd <-ggplot(data=subset(prosper, !is.na(InquiriesLast6Months)), aes(x = factor(InquiriesLast6Months), y = BorrowerAPR))+
  geom_boxplot()+
  geom_smooth(aes(group = 1, color = 'red'))+
  theme(text = element_text(size = 10), legend.position = 'none')+
  scale_x_discrete(limits = c("0",1,2,3,4,5,6,7,8,9,10,11), breaks = c("0",1,2,3,4,5,6,7,8,9,10,11))

grid.arrange(plot1_crd, plot2_crd, plot3_crd, plot4_crd, ncol = 2)

```

These charts provide additional information from the correlation values to APR from the ggpairs calculation.  
*Loan Original Amount shows two peaks in APR at loans of 3k and at 7.5k  
*The curves flatten eventually indicating there is an upper and lower limit to the borrower APR, (although the loans are still issued at high risk values.)  

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=5}
plot1_card <-ggplot(data = subset(prosper, AvailableBankcardCredit ==0), 
                    aes(x = BorrowerAPR))+
  geom_histogram(binwidth = 0.02)+
  scale_y_sqrt()+
  ylab("count, sqrt")+
  xlim(0, 0.45)+
  theme(text = element_text(size = 10))+
  ggtitle("Distribution of Borrower APR, Bankcard credit = 0")
  
plot2_card <- ggplot(data = subset(prosper, AvailableBankcardCredit >0), 
                    aes(x = BorrowerAPR))+
  geom_histogram(binwidth = 0.02)+
  scale_y_sqrt()+
  ylab("count, sqrt")+
  xlim(0, 0.45)+
  theme(text = element_text(size = 10))+
  ggtitle("Distribution of Borrower APR, Bankcard credit > 0")

grid.arrange(plot1_card, plot2_card, ncol = 1)
```

The distribution of loans at various APRs is noticably different between borrowers w/ AvailableBankcardCredit = 0 and != 0.  The rates are higher for borrowers w/ no Bankcard credit.  Also, the peak at 0.36 is more noticeable for borrowers with no Bankcard credit, although the peak exists on both plots.  
*Note difference in y-scale*

####Review credit rating variables and APR v. Loan Status
```{r, echo = FALSE, warning=FALSE, message=FALSE}
prosper.na = subset(prosper, !is.na(prosper$LStatus))
plot1_stat <- ggplot(data = prosper.na, aes(x = LStatus, y =BorrowerAPR ))+
  geom_boxplot()

plot2_stat <- ggplot(data = prosper.na, aes(x = LStatus, y =ProsperScore ))+
  geom_boxplot()

plot3_stat <- ggplot(data = prosper.na, 
                     aes(x = LStatus, y =CreditScoreRangeUpper ))+
  geom_boxplot()+
  ylim(c(400,900))

grid.arrange(plot1_stat, plot2_stat, plot3_stat, ncol = 3)
```

These charts indicate that the price of the loan does take into consideration the associated risk based on the borrowers credit scores.  The prosperscore shows a larger relative difference between Loan Status result than the CreditScoreRangeUpper.  

```{r, echo = FALSE, warning=FALSE, message=FALSE}
by(prosper.na$ProsperScore, prosper.na$LStatus, summary)
by(prosper.na$CreditScoreRangeUpper, prosper.na$LStatus, summary)
by(prosper.na$BorrowerAPR, prosper.na$LStatus, summary)

```

####Build Linear Model

```{r, echo = FALSE, warning=FALSE, message=FALSE}
prosper.na$AvailCreditLog10 <- log10(prosper.na$AvailableBankcardCredit)

m1 <- lm(BorrowerAPR ~ ProsperScore, data = prosper.na)
m2 <- update(m1, ~ . + CreditScoreRangeUpper)
m3 <- update(m2, ~ . + AvailableBankcardCredit)
m4 <- update(m3, ~ . + log10(LoanOriginalAmount))
m6 <- update(m4, ~ . + InquiriesLast6Months)

mtable(m1, m2, m3, m4, m6)

summary(m6)

```


####Summary of Bivariate Analysis
Several variables contribute to the Borrower APR (price of the loan), including ProsperScore CreditScoreRange, AvailableBankcardCrdit, LoanOriginalAmount, BankcardUtilization, Delinquencies(7year), CurrentDelinquincies, and Inquiries(6mos).  
* Bankcard Utiliazation correlated to Available Bankcard Credit (-0.37)  
* Current Delinquencies correlated to Delinquencies(7 year) (0.384)   
* These variables were not included in the bivariate analysis nor the model to avoid issues with collinear variables  

The linear model has an R^2 factor of 0.60.  this is a moderate result and reflects applying a linear model to non-linear relationships between the variables (NOTE - log10 relationships were explored for certain variables and adopted for LoanOriginalAmount)  

Income shows a weak correlation to BorrowerAPR  (-0.14).  it did not improve the model (R), and is not included in the model.  

It is assumed that Borrower APR reflects the risk of the loan.  A borrower has to pay more if they are more likely to default.  
* The BorrowerAPR is a good reflection of loan risk - the median borrowerAPR forloans in good standing is 20% and 25.4% for loans in default.   
*The ProsperScore appears to be a better predictor of loan status than CreditScoreUpper with a larger difference of scores based on LStatus  
  + ProsperScore 6 (good) to 5 (default) = 16%
  + CreditScoreUpper 719 (good) to 659 (default) = 8%


###Multivariate Plots  
```{r, echo = FALSE, warning=FALSE, message=FALSE, results="hide"}

prosper.naLStatus <- subset(prosper, !is.na(LStatus))

```

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=6}

# for report.  previous chunk contains originals and work.  

plot1_heat <- ggplot(data = subset(prosper.naLStatus, !is.na(ProsperScore)& prosper.naLStatus$LStatus == "good standing"), aes(x = factor(ProsperScore) , y =CreditScoreRangeUpper))+
  geom_bin2d(binwidth = c(1,20))+
  geom_smooth(aes(color = LStatus, group = 1))+
  scale_y_continuous(limits = c(620,900), breaks = seq(620,900,40))+
  theme(text=element_text(size = 10))+
  ggtitle("ProsperScore by CreditScore, Good standing loans")

plot2_heat <- ggplot(data = subset(prosper.naLStatus, !is.na(ProsperScore) & prosper.naLStatus$LStatus != "good standing"), aes(x = factor(ProsperScore) , y =CreditScoreRangeUpper))+
  geom_bin2d(binwidth = c(1,20))+
  geom_smooth(aes(color = LStatus, group = 1), color = "yellow")+
  scale_y_continuous(limits = c(620,900), breaks = seq(620,900,40))+
    theme(text=element_text(size = 10))+
  ggtitle("ProsperScore by CreditScore, Negative loans")

grid.arrange(plot1_heat, plot2_heat, ncol = 1)
```


```{r, echo = FALSE, message = FALSE, warning=FALSE}
library(tidyr)

#create by year on x, prosperscore and creditscore / 100 by LStatus

prosper.year <- subset(prosper, !is.na(LStatus)) %>%
  group_by(year, LStatus) %>%
  summarize(mean_CreditScore = mean(CreditScoreRangeUpper, na.rm = TRUE), 
            mean_ProsperScore = mean(ProsperScore, na.rm = TRUE), n = n())%>%
  ungroup()

ggplot(data = prosper.year, 
       aes(x = year, y = mean_CreditScore/100, color = LStatus)) + 
  geom_line()+
  geom_line(aes(y = mean_ProsperScore), linetype = 2)+
  ylab('Prosper Score (dash) or credit score / 100 (solid)')+
  scale_x_continuous(limits = c(2005, 2014), breaks = seq(2005, 2014, 1))+
  ggtitle("CreditScore by year w loan status")
```

While the difference in mean credit scores has decreased over time for loans in good v negative standing, the mean prosper score has diverged, indicating it has become a better predictor of whether a loan will be good or negative status

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=4.5}
#quantile(prosper$BorrowerAPR, probs = 0.01, na.rm = TRUE)
#quantile(prosper$BorrowerAPR, probs = 0.99, na.rm = TRUE)

ggplot(data = subset(prosper, (LP_CustomerPrincipalPayments/LoanOriginalAmount)<0.99), aes(x=BorrowerAPR, 
    y = (LP_CustomerPrincipalPayments/LoanOriginalAmount)*100, 
    color = LStatus))+
  geom_point(alpha = 0.1)+
  ylim(0,100)+
  scale_x_continuous(limits =c(0.06, 0.38), breaks = seq(0.06,0.38,0.04))+
  geom_smooth(method = "lm")+
  ylab("% Total Loan Paid")+
  theme(text = element_text(size = 10))+
  ggtitle("Unpaid Loans by APR")

plot2_borrow <- ggplot(data = subset(prosper, (LP_CustomerPrincipalPayments/LoanOriginalAmount)<=0.99), 
                       aes(x=BorrowerAPR, fill = LStatus))+
  geom_histogram(binwidth = 0.01, position = "dodge")+
  theme(text = element_text(size = 10))+
  theme(legend.position = "bottom")+
  ggtitle("Unpaid Loans, count by APR")+
  scale_x_continuous(limits =c(0.06, 0.38), breaks = seq(0.06,0.38,0.04))

plot3_borrow <- ggplot(data = subset(prosper, (LP_CustomerPrincipalPayments/LoanOriginalAmount)>0.99), 
                       aes(x=BorrowerAPR, fill = LStatus))+
  geom_histogram(binwidth = 0.01)+
  theme(text = element_text(size = 10))+
  ggtitle("Paid Loans, count by APR")+
  scale_x_continuous(limits =c(0.06, 0.38), breaks = seq(0.06,0.38,0.04))+
  theme(legend.position = 'none')

grid.arrange(plot2_borrow, plot3_borrow, ncol = 2)
```

This set of plots investigates the % of a loan that is paid off.  The first plot demonstrates loans with >1% of the total loan still due (effectively, all unpaid loans).  
*  the trend for higher APRs at good standing is due to the APR rate of the loan when it was issued and the length of time the loan has been open and one should not draw conclusions on this trend.  
* the trend for default loans is interesting, as these loans are closed as unpaid.  It is clear that borrowers pay more of the loan when then have a lower interest rate than when they have a higher interest rate!  More investigation is needed to better understand this trend, but if it hold up, it has interesting implications when pricing loans.  Financially it may be more beneficial to receive back more principle and less interest.  

the set of charts of distributions with completed and uncompleted loans has an expected trend of higher completed loans, and loans in good standing distributed at lower APRs, and loans with negative standing distributed at higher APRs.  

```{r, echo = FALSE, warning=FALSE, message=FALSE}
prosper.naLStatus <- subset(prosper, !is.na(LStatus))

ggplot(data = prosper.naLStatus, aes(x = factor(year), y = BorrowerAPR, color = LStatus))+
  geom_boxplot()+
  xlab("Year")+
  theme(text = element_text(size = 10))+
  ggtitle("Borrower APR by Year by Loan Status")
```

This graph plots the change in APR by Loan status by year.  There are two notable trends in this graph.  
* APRs are consistently and noticeably lower for Loans with positive status but this gap becomes very small in 2011 based on increased APRs for loans in good standing.  
* In 2011, APRs for loans tihe begative status (late or default), declined very slightly from 2010, while te APR for loans in good standing increased as noted in the previous item.  
The fluctuations of the APR by year also indicate the economic conditions - although it appears it takes longer for APRs to come down that it does for them to go up.  

```{r, echo = FALSE, warning = FALSE, message=FALSE}
plot1_yr <- ggplot(data = prosper, aes(x = year))+
  geom_histogram(aes(fill = LStatus), position = 'fill')+
  theme(legend.position = "bottom")+
  theme(text = element_text(size = 10))+
  scale_x_continuous(limits = c(2006,2014), breaks = seq(2006,2014,1))

plot2_yr <- ggplot(data = prosper, aes(x = year))+
  geom_histogram(aes(fill = LStatus), position = 'stack')+
  theme(legend.position = "bottom")+
  theme(text = element_text(size = 10))+
  scale_x_continuous(limits = c(2006,2014), breaks = seq(2006,2014,1))

grid.arrange(plot1_yr, plot2_yr, ncol=2)
```

there is a very noticeable improvement in loan status, even during the economic downturn from Q4-2007 to Q2-2009 (note that the year is inital year of the loan).  2010 is the year that prosper reset after SEC intervention, and also when they introduced their ProsperScore.


```{r, echo = FALSE, warning= FALSE, message=FALSE, fig.height=8}

# update variables from model with LStatus to see if there are any interesting trends:  
#create subset of prosper w/o LStatus = NA


plot1_mv <- ggplot(data = subset(prosper.naLStatus, 
  !is.na(prosper.naLStatus$AvailableBankcardCredit)& 
    prosper.naLStatus$AvailableBankcardCredit >0),
  aes(x = log10(AvailableBankcardCredit), y = BorrowerAPR))+
  geom_point(alpha = 0.01)+
  geom_smooth(aes(color = LStatus))+
  theme(text = element_text(size = 10))+
  theme(legend.position = "bottom")

plot2_mv <- ggplot(data = prosper.naLStatus, 
        aes(x = log10(LoanOriginalAmount), y=BorrowerAPR, color = LStatus))+
  geom_point(alpha = 0.01)+
  geom_smooth(aes(color = LStatus), method = "lm")+
  theme(text = element_text(size = 10))+
  theme(legend.position = "bottom")

plot3_mv <- ggplot(data = prosper.naLStatus, 
        aes(x = DelinquenciesLast7Years, y = BorrowerAPR, color = LStatus))+
  geom_point(alpha = 0.05)+
  geom_smooth(aes(color = LStatus), method = "gam")+
  theme(text = element_text(size = 10))+
  theme(legend.position = "bottom")+
  xlim(c(0, quantile(prosper$DelinquenciesLast7Years, probs = 0.99, 
                     na.rm = TRUE)))

plot4_mv <- ggplot(data=subset(prosper.naLStatus, !is.na(InquiriesLast6Months)), aes(x = factor(InquiriesLast6Months), y = BorrowerAPR, color = LStatus))+
  geom_boxplot()+
  xlab("InquiriesLast6Months")+
  theme(text = element_text(size = 10), legend.position = 'bottom')+
  scale_x_discrete(limits = c("0",1,2,3,4,5,6,7,8,9,10,11), breaks = c("0",1,2,3,4,5,6,7,8,9,10,11))

grid.arrange(plot1_mv, plot2_mv, plot3_mv, plot4_mv)
```

These graphs of the key variables affecting Borrower APR now indicate the status of the loan (good, late, or default).  The graphs support that the APR is appropriatedly assigned to price a higher risk more than a lower risk loan since good standing loans have lower rates than defauled loans.  late loans are not consistent.  
* Two notable observations  
  + for larger loans (greater than 4.5 (log10)), loans with negative status have a lower APR than loans with good status this is not desirable  
  + as inquires last 6 months increases, the APR for default loans remains exactly the same, regardless of the number of inquires where APR increased relative to number of inquires for good standing and for late loans.  
  
```{r, echo=FALSE, warning = FALSE, message = FALSE, results = "hide"}
by(prosper.naLStatus$AvailableBankcardCredit, prosper.naLStatus$LStatus,summary)
```


####Summary of Multivariate plots  
* Added further depth to the bivariate analysis by including loan status information and loan payment information, as well as investigating changes over time.  
  + The prosper score is a better indicator of loan status than credit score, and the delta has increased over time.  
  + Plotting variables that affect APR with loan status indicate there are some inconsistencies in the assumption that higher APR results in higher default at higher loan values and at higher credit inquiries.  
  + Borrowers with a higher APR that are in negative status tend to pay off a lower portion of their loan.  However, APR is affected by year (economic and competitive factors) in addition to the credit worthiness of the borrower so there are other factors at play.  
  + The number and % of loans in good standing has increased  noticeably based on the year the loan was initiated.  Once again, this is a factor of economic factors and also better ability to grant and price loans accordingly.  

##Final Plots and Analysis  
###Graph 1 - ProsperScore v. Loan Status
```{r, echo = FALSE, warning= FALSE, message= FALSE}
ggplot(data = prosper.naLStatus, 
       aes(x = LStatus, y =ProsperScore, color = LStatus ))+
  geom_boxplot()+
  xlab("Loan Status")+
  scale_y_continuous(limits = c(1,11), breaks = seq(1,11,1))+
  ggtitle("ProsperScore by Loan Status")+
  scale_color_discrete(name = "Loan Status")

```

* The ProsperScore is the Prosper internal designation of the credit-worthiness of a loan, and it is the variable that correlates highest to the APR that is assigned to the loan (-0.668).  Compared to the externally available CreditScoreUpper(FICO score) variable (correlates -0.431), the ProsperScore is a better score.  
* This plot demonstrates that loans in good standing have a 20% higher ProsperScore than late and default loans.  
* The conclusion from this plot is that the ProsperScore is a good indicator of the borrower being in good standing (Good standing = Loan is current, or completed)  
* The business implication is that the more accurate a borrowers creditworthiness can be determined, the better the APR can be optimized.  This is a competitive advantage in the marketplace for loans.  

###Graph 2 - Variables affecting Borrower APR
```{r, echo = FALSE, warning= FALSE, message= FALSE, fig.height=8}

plot1_mvf <- ggplot(data = subset(prosper.naLStatus, 
    !is.na(prosper.naLStatus$AvailableBankcardCredit) & 
      prosper.naLStatus$AvailableBankcardCredit >0),
    aes(x = log10(AvailableBankcardCredit), y = BorrowerAPR*100))+
  geom_point(alpha = 0.01)+
  geom_smooth(aes(color = LStatus))+
  theme(text = element_text(size = 10))+
  theme(legend.position = "bottom")+
  xlab("Available Bankcard Credit, log scale ($)")+
  ylab("Annual Percentage Rate (APR), %")+
  ggtitle("APR by Available Bank Credit")+
  scale_color_discrete(name = "Loan Status")

plot2_mvf <- ggplot(data = prosper.naLStatus, 
    aes(x = log10(LoanOriginalAmount), y = BorrowerAPR*100, color = LStatus))+
  geom_point(alpha = 0.02)+
  geom_smooth(aes(color = LStatus), method = "auto")+
  theme(text = element_text(size = 10))+
  theme(legend.position = "bottom")+
  xlab("Original Loan Amount, log scale ($)")+
  ylab("Annual Percentage Rate (APR), %")+
  ggtitle("APR by Original Loan Amount")+
  scale_color_discrete(name = "Loan Status")

plot3_mvf <- ggplot(data = prosper.naLStatus, aes(x = DelinquenciesLast7Years, 
                                    y = BorrowerAPR*100, color = LStatus))+
  geom_point(alpha = 0.02)+
  geom_smooth(aes(color = LStatus), method = "auto")+
  theme(text = element_text(size = 10))+
  theme(legend.position = "bottom")+
  xlab("# of Delinquencies (last 7 years)")+
  ylab("Annual Percentage Rate (APR), %")+
  xlim(c(0, quantile(prosper$DelinquenciesLast7Years, 
                     probs = 0.99, na.rm = TRUE)))+
  ggtitle("APR by Delinquencies (last 7 years)")+
  scale_color_discrete(name = "Loan Status")

plot4_mvf<-ggplot(data=subset(prosper.naLStatus, !is.na(InquiriesLast6Months)), aes(x = factor(InquiriesLast6Months), y = BorrowerAPR*100, color = LStatus))+
  geom_boxplot()+
  xlab("# of Inquiries (last 6 Mos)")+
  scale_color_discrete(name = "Loan Status")+
  theme(text = element_text(size = 10), legend.position = 'bottom')+
  ggtitle("APR by Inquires (Last 6 Mos)")+
  scale_x_discrete(limits = c("0",1,2,3,4,5,6,7,8,9,10,11), breaks = c("0",1,2,3,4,5,6,7,8,9,10,11))

grid.arrange(plot1_mvf, plot2_mvf, plot3_mvf, plot4_mvf, ncol=2)
```
  
1. This set of plots includes the variables with the highest correlation to APR for prosper loans, and also plots the status of loans  
  + The Avaliable Bankcard Credit (correlation -0.347) and Original loan amount (correlation (log10) -0.316) both drive a lower APR as their values increase  
  + Delinquencies (correlation 0.157) and Credit Inquiries (correlation 0.14) both drive a higher APR as their values increase    
2. The linear model built with these variables (+prosperscore and creditscoreupper) has an R^2 value of 0.60, which indicates a modest fit.  
  + All of these graphs are non-linear, particularly at the extremes of the variable  
  + APR peaks on the Original Loan Amount plot at $3k and $7.5k.  A log scale is shown here because it correlates better, and peaks are noticable at 10^3.5 and 10^3.8.  All loan status levels follow this trend.    
  + for larger loans (greater than ~10^4.5 = $30k), loans with negative status have a lower APR than loans with good status this is not desirable.  
3. The graphs support that the APR is appropriatedly assigned to price a higher risk more than a lower risk loan since good standing loans have lower rates than defauled loans.  late loans are not consistent.  
Conclusion - Variables that negatively affect APR also trend to higher negative loan status, and thhese charts indicate that the extreme values of the variables is where the linearity is the poorest fit.    

###Graph 3 - Trends by year
```{r, echo = FALSE, warning= FALSE, message= FALSE}
#note, using previously calculated 0.01 to 0.99 range.  

ggplot(data = prosper.naLStatus, 
       aes(x = factor(year), y = BorrowerAPR*100, color = LStatus))+
  geom_boxplot()+
  scale_y_continuous(limits = c(6,38), breaks = seq(6,38,4))+
  ylab("Loan Rate, APR (%)")+
  theme(text = element_text(size = 10))+
  scale_color_discrete(name = "Loan Status")+
  ggtitle("Borrower APR by Year by Loan Status")+
  xlab("Year")

```

This plot graphs the APR by the year they were initiated with their loan status.  and provides information on how APRs have changed over time and the result on the loan status.  It is important to consider the great recession from late 2007 to mid 2009 had a significant impact on credit for the early years of this graph.  There are several notable trends in this graph.  

* APRs are consistently and noticeably lower for Loans with positive status but this gap becomes very small in 2011 based on increased APRs for loans in good standing.  
* In 2011, APRs for loans with negative status (late or default), declined very slightly from 2010, while te APR for loans in good standing increased noticeably.    
* The fluctuations of the APR by year also indicate the economic conditions - although it appears it takes longer for APRs to come down that it does for them to go up.  
* The range of APR has become smaller, particularly with very few loans above 35%  
*Note - loan status is real time, and reflected on the year the loan was initiated.  Loans must be active to have "late" status.  Loans initiated prior to 2010 are no longer active.  There are no default loans in 2014 due to timing - loans are late for 120 days before going to default*  

##Reflections  
I'm astounded and stoked about the level of information in this project.  
The number of variables created a huge challenge.  It took considerable effort to determine the focus of this project - specifically the borrowers creditworthiness, the APR, and the relationship between APR and Loan Status.  
I spent several hours trying to correlate Loan Status with various factors, but the analysis was really uninteresting.  Once I  determined that the APR, or price of the loan, was the more important factor, and then consolidated the LoanStatus factors into Good, Late, Default, the project went very smoothly.  

The data set is so rich, and a team of analyst are certainly busy at Prosper.  This analysis focuses on the price of loans (APR) and their status compared to loan parameters and the borrowers creditworthiness.  
A few items were surprising -  

* There is almost no correlation between the borrowers income and the borrowers APR  
* The correlation between Loan amount and APR is less linear than expected, with a few peaks, and declining rates at higher loan amounts   
* Prosper has a better algorithm than the credit companies for determining credit scores as it relates to assigning APRs that are an appropriate reflection of risk  
  + Prosper's ability to gather data on loans as they are paid on a real time basis and modify their models is a big advantage over the credit reporting companies
  
Points for further investigation  

* A few variables were investigated over time to explain charts, but given the external variables that affect APR, an entire additional project could be completed on correlation over time, or at least pre 2009 and post 2009.  Tying in external data would be particularly interesting - what portion of Prosper's improved results is due to an improved economy, and what is due to improved modeling?  
* Financials -  investigate what segment of loans is the most profitable / least profitable.  Determine if some of the prosper generated variables correlate to the profitability of the loans  
* Marketing - there are very few referrals in the database, but as a prosper lender, I am aware they have regular programs to encourage lending and borrowing.  Exploring these relationships would be an interesting project as well.  
* compare correlation pre and post 2009  
* compare financials of higher and lower APR given default rates
